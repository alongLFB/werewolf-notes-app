# 🎯 最新问题修复总结

## ✅ 已修复的问题

### 1. 第二晚记录行动添加不到日志的问题

**问题描述**:

- 第一晚可以正常记录行动
- 第二晚点击"记录行动"后没有添加到日志

**根本原因**:

- 当游戏进入新回合时，如果该回合还没有 Round 对象，`addNightAction` 函数找不到对应的回合
- 导致行动记录失败

**解决方案**:

- 在 `addNightAction` 函数中添加了创建新回合的逻辑
- 如果当前回合不存在，自动创建新的 Round 对象
- 确保每个回合都能正常记录夜间行动

**修改的代码**:

```typescript
// 在 addNightAction 中添加 else 分支
} else {
  // 创建新回合
  const newRound: Round = {
    number: currentGame.currentRound,
    phase: currentGame.currentPhase,
    votes: [],
    nightActions: [action],
    actionLog: [],
  };

  set({
    currentGame: {
      ...currentGame,
      rounds: [...currentGame.rounds, newRound],
    },
  });
}
```

### 2. 玩家名称和身份同时显示

**问题描述**:

- 之前要么只显示玩家名称，要么显示角色信息
- 用户希望默认同时显示玩家名称和身份

**解决方案**:

- 修改 `PlayerCard` 组件的显示逻辑
- 在显示身份时，玩家名称后面直接显示角色信息
- 只有点击"隐藏身份"后才只显示玩家名称

**修改效果**:

- **显示身份时**: `张三 狼人` / `李四 预言家`
- **隐藏身份时**: `张三` / `李四`

**UI 改进**:

- 角色信息以小标签形式显示在玩家名称后
- 保持原有的颜色区分功能
- 更加直观和实用

## 🎮 测试步骤

### 测试第二晚行动记录

1. 创建游戏并进行第一晚的行动记录 ✓
2. 进入第二回合（白天 → 夜晚）
3. 在第二晚尝试记录行动
4. 检查游戏日志是否正常显示第二晚的行动 ✓

### 测试玩家身份显示

1. 为玩家分配角色
2. 默认状态下应该看到 `玩家名 角色名`
3. 点击"隐藏身份"按钮
4. 应该只显示玩家名称
5. 再次点击"显示身份"应该恢复显示角色信息

## 📋 完整功能状态

- ✅ 游戏创建和基础流程
- ✅ 夜间行动记录（所有回合）
- ✅ 白天投票记录
- ✅ 警长竞选系统
- ✅ 夜晚结算机制
- ✅ 完整的日志系统
- ✅ 权限控制（上帝/玩家视角）
- ✅ 玩家身份显示优化
- ✅ 游戏结束返回首页

现在您的狼人杀游戏应该完全正常工作了！🎉
