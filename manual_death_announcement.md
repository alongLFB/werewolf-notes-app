# 死亡公布机制优化 - 主动触发版本

## 修改原因

用户反馈：有人当选警长了，但还是没自动公布死亡信息。自动触发可能存在时序问题。

## 解决方案

将死亡公布改为主动触发模式，更可靠且用户可控。

## 关键修改

### 1. GameControlPanel.tsx

- **原来**: 只在第一回合且有警长时显示死亡公布按钮
- **现在**: 在所有白天阶段都显示死亡公布按钮

```tsx
// 修改前：限制条件太多
{
  currentGame.currentRound === 1 && isDay && currentGame.sheriff && (
    <button>公布昨夜死亡</button>
  );
}

// 修改后：任何白天都可以使用
{
  isDay && <button>公布昨夜死亡</button>;
}
```

### 2. gameStore.ts - electSheriff 函数

- **原来**: 警长当选后自动触发死亡公布
- **现在**: 警长当选后只提示用户手动点击按钮

```typescript
// 修改前：自动触发
setTimeout(() => {
  get().announceNightDeaths();
  get().addActionLog("警长选举结束，现在开始白天讨论和投票");
}, 500);

// 修改后：提示手动操作
get().addActionLog(
  "警长选举结束，请点击'公布昨夜死亡'按钮查看第一晚的死亡情况"
);
```

### 3. announceNightDeaths 函数增强

- 添加防重复公布检查
- 添加白天/夜晚限制提示
- 添加流程提示信息

```typescript
// 防重复公布
if (
  currentRoundData?.actionLog.some(
    (log) => log.includes("昨夜死亡公布") || log.includes("昨夜平安")
  )
) {
  get().addActionLog("本回合的死亡信息已经公布过了");
  return;
}

// 夜晚限制
if (currentGame.currentPhase !== "day") {
  get().addActionLog("只能在白天公布死亡信息");
  return;
}
```

## 优势

1. **可靠性**: 避免了自动触发的时序问题
2. **用户控制**: 用户可以选择合适的时机公布死亡
3. **防误操作**: 防止重复公布同一回合的死亡信息
4. **清晰提示**: 明确告知用户何时可以公布死亡

## 游戏流程

### 第一回合

1. 夜晚行动 → 夜晚结算
2. 进入白天 → "第一个白天开始，请先进行警长选举"
3. 警长选举 → 警长当选 → "警长选举结束，请点击'公布昨夜死亡'按钮查看第一晚的死亡情况"
4. **用户手动点击"公布昨夜死亡"按钮**
5. 系统公布死亡 → "第一晚死亡公布完毕，现在开始白天讨论和投票"

### 第二回合及以后

1. 夜晚行动 → 夜晚结算
2. 进入白天 → **自动公布昨夜死亡** → 开始白天讨论投票
3. （用户仍可手动点击按钮，但会提示"本回合的死亡信息已经公布过了"）

## 按钮状态

- **白天**: 显示"公布昨夜死亡"按钮
- **夜晚**: 不显示按钮
- **重复点击**: 提示已经公布过

现在用户在第一回合警长选举后可以主动控制死亡公布的时机，解决了自动触发的可靠性问题。
